$(function(){$("body").one("pinegrow-ready",function(e,t){var a=new PgFramework("pg.components","Components");t.addFramework(a),a.setScriptFileByScriptTagId("plugin-pg-components","lib/crsa/plugins/pg.components.js");var n=require("path"),o=require("fs"),i=function(){return t.isPRO()||t.isProTrialActive()};a.detect=function(){return!1},a.default=!0,a.has_actions=!0,a.show_in_manager=!1,a.order=1e3;var r=[],s=[],c=null;t.insight.addHandler(function(){l.master_pages=[],l.master_pages_changed=!0,l.component_types_map={},l.component_types_list=[]},function(){return function(e,t,a){"html"==a.tagName&&a.hasAttr("data-pgc-set-master")&&p(t.name)}},function(){l.master_pages_changed&&(l.master_pages.sort(),l.master_pages_changed=!1)});var l={getMasterPages:function(){var e=[];return l.master_pages.forEach(function(t){e.push({key:t,name:t})}),e},getComponents:function(){var e=[],a=t.getSelectedPage();return a&&a.getFrameworks().forEach(function(t){t.components_loaded&&$.each(t.getComponentTypes(),function(a,n){n.is_smart_component&&e.push({key:n.type,name:n.type,html:n.type+(n.type!=n.name?" ("+n.name+")":"")+" <small>"+t.name+"</small>"})})}),t.insight.sortOptionsList(e),e},getEditableFieldsForElement:function(e){var a=[],n=getElementPgNode(e),o=function(e,t){e.component_fields&&$.each(e.component_fields,function(n,o){a.push({key:o.name,name:o.name,html:o.name+" <small>"+(t||"")+e.name+"</small>"})})};if(n){var i=t.getCrsaPageOfPgParserNode(n),r=Rt(n,i);if(r)o(r);else{var s=t.getCurrentProject();if(s){var c=pt(i,s);c?o(c,"master page "):a.push({key:"",name:"",html:"<small>Assign component or master page to see editable fields.</small>"})}}t.insight.sortOptionsList(a)}return a}};t.insight.ext.components=l;var p=function(e){l.master_pages.indexOf(e)<0&&(l.master_pages.push(e),l.master_pages_changed=!0)},d=new PgComponentType("pgc.define","Define component");d.short_name="Define comp.",d.selector="[data-pgc-define]",d.attribute="data-pgc-define",d.action=!0,d.not_main_type=!0,d.sections={"pgc.define.parameters":{name:"Options",fields:{"data-pgc-define":{type:"text",name:"Id",action:"element_attribute",attribute:"data-pgc-define",attribute_keep_if_empty:!0,validate:a.fieldIsRequired,placeholder:a.textForExample("my.poster"),options:function(){return t.insight.ext.components.getComponents()}},"data-pgc-define-name":{type:"text",name:"Display name",action:"element_attribute",attribute:"data-pgc-define-name",placeholder:a.textForExample("Poster")},"data-pgc-define-auto-update":{type:"checkbox",name:"Update instances",action:"element_attribute",attribute:"data-pgc-define-auto-update",value:"true",negvalue:"false",default_value:"true",on_changed:function(e,a,n){"false"==n?t.showQuickMessage("Component instances <b>will not</b> be updated when you run Components -&gt; Update.",3e3):t.showQuickMessage("Be careful, running Components -&gt; Update <b>will change</b> component instances.",4e3,!1,!0)}},"data-pgc-define-description":{type:"text",name:"Description",action:"element_attribute",attribute:"data-pgc-define-description"},"data-pgc-define-photo-preview-only":{type:"checkbox",name:"Use photo only for preview",action:"element_attribute",attribute:"data-pgc-define-photo-preview-only",empty_attribute:!0,value:"true"}}}},a.addComponentType(d),r.push(d),d.meta={helptext:'Define Pinegrow component.<span class="more"> Disable <b>Update instances</b> if you don\'t want component instances to be updated with Components -&gt; Update. In that case you can update them manually with Actions -&gt; Update component.</span>'};var u=1,m=function(e){var t=f(e.attr("data-pgc-field")||e.attr("data-pgc-edit"));return'<i class="fa fa-pencil"></i> '+(t.name||"")},g=new PgComponentType("pgc.edit","Define editable area");g.short_name="Editable",g.selector="[data-pgc-edit]",g.attribute="data-pgc-edit",g.action=!0,g.not_main_type=!0,g.get_action_tag=m;var f=function(e){var t={name:null,attrs:[],content:!0,repeat:!1};if(!e)return t;var a=e.match(/^([^\[]*)(\[.*\]|)$/);if(a&&(t.name=$.trim(a[1]),a[2].length>0))for(var n=a[2].replace("[","").replace("]","").split(","),o=0;o<n.length;o++){var i=$.trim(n[o]).toLowerCase();"no_content"==i?t.content=!1:t.attrs.push(i)}return t},h=function(e){var t=e.name,a=e.attrs;return e.content||a.push("no_content"),a.length&&(t+="["+a.join(", ")+"]"),t},v=function(e,t,a,n,o){-1===t&&(t=o["data-pgc-edit"]),-1===a&&(a=o["data-pgc-edit-content"]),-1===n&&(n=o["data-pgc-edit-attrs"]);var i={name:t,content:"1"!=a,attrs:null};i.attrs=n?n.split(","):[];for(var r=0;r<i.attrs.length;r++)i.attrs[r]=$.trim(i.attrs[r]);var s=h(i);e.attr(g.attribute,s)};a.getFieldDefinitionStringForEditableAttribute=function(e,t,a){var n=null;if(e){var o=f(e);o.attrs.indexOf(t)<0&&o.attrs.push(t),n=h(o)}else n=a+"["+t+",no_content]";return n},g.sections={"pgc.edit.parameters":{name:"Options",fields:{"data-pgc-edit":{type:"text",name:"Field Id",action:"custom",options:function(){var e=t.insight.getValuesForAttribute("data-pgc-edit");return e.forEach(function(e){var t=f(e.key);t&&(e.name=t.name,e.key=t.name)}),e},get_value:function(e){var t=new pgQuery(e.data),a=t.attr(g.attribute);if(a){var n=f(a);return n.name}return null},set_value:function(e,t,a){var n=new pgQuery(e.data);return t?v(n,t,-1,-1,a):n.removeAttr(g.attribute),t},validate:a.fieldIsRequired,placeholder:a.textForExample("block_title")},"data-pgc-edit-attrs":{type:"select",multiple:!0,can_add_items:!0,options:function(e,a){var n=[];return $.each(a.data[0].attributes,function(e,t){t.name.startsWith("data-pg")||n.push({key:t.name,name:t.name})}),t.insight.sortOptionsList(n),n},name:"Editable attributes",action:"custom",get_value:function(e){var t=new pgQuery(e.data),a=t.attr(g.attribute);if(a){var n=f(a);return n.attrs.length?n.attrs.join(", "):null}return null},set_value:function(e,t,a){var n=new pgQuery(e.data);return v(n,-1,-1,t,a),t}},"data-pgc-edit-classes":{type:"select",multiple:!0,can_add_items:!0,name:"Editable classes",action:"element_attribute",attribute:"data-pgc-edit-classes",placeholder:a.textForExample("active, inactive"),options:function(e,a){var n=[];return $.each((a.data.attr("class")||"").split(/\s+/),function(e,t){t.startsWith("crsa-")||n.push({key:t,name:t})}),t.insight.sortOptionsList(n),n}},"data-pgc-edit-content":{type:"checkbox",name:"Do NOT edit content",action:"custom",value:"1",get_value:function(e){var t=new pgQuery(e.data),a=t.attr(g.attribute);if(a){var n=f(a);return n.content?null:"1"}return null},set_value:function(e,t,a){var n=new pgQuery(e.data);return v(n,-1,t,-1,a),t}},"data-pgc-edit-bckimage":{type:"checkbox",name:"Bck. image",action:"element_attribute",attribute:"data-pgc-edit-bckimage",value:"1",empty_attribute:!0},"data-pgc-edit-types":{type:"select",multiple:!0,can_add_items:!1,options:function(){return t.insight.ext.components.getComponents()},name:"Allowed components in content",action:"element_attribute",attribute:"data-pgc-edit-types"}}}},g.meta={helptext:"Make the element editable. Inner content of the element is editable by default."},a.addComponentType(g),s.push(g);var b=new PgComponentType("pgc.repeat","Define repeatable area");b.short_name="Repeat",b.selector="[data-pgc-repeat]",b.attribute="data-pgc-repeat",b.action=!0,b.not_main_type=!0,b.sections={"pgc.repeat.parameters":{name:"Options",fields:{"data-pgc-repeat":{type:"text",name:"Field Id",action:"element_attribute",attribute:"data-pgc-repeat",attribute_keep_if_empty:!0,placeholder:a.textDefaultValue("editable field id")}}}},b.meta={helptext:"The editable area can be repeated by duplicating it as many times as needed."},a.addComponentType(b),s.push(b);var _=new PgComponentType("pgc.optional","Define optional area");_.short_name="Optional",_.selector="[data-pgc-optional]",_.attribute="data-pgc-optional",_.action=!0,_.not_main_type=!0,_.sections={"pgc.optional.parameters":{name:"Options",fields:{"data-pgc-optional":{type:"text",name:"Field Id",action:"element_attribute",attribute:"data-pgc-optional",attribute_keep_if_empty:!0,placeholder:a.textDefaultValue("editable field id")},"data-pgc-optional-restore":{type:"checkbox",name:"Restore on update",action:"element_attribute",attribute:"data-pgc-optional-restore",empty_attribute:!0,value:"true"}}}},_.meta={helptext:'The element can be deleted from component instances.<span class="more">To get back deleted optional areas use <b>Actions -&gt; Restore optional areas</b> on instances / child pages - or - check <b>Restore on update</b>, update and then uncheck it (that will restore that field in all updated instances).</span>'},a.addComponentType(_),s.push(_);var y=new PgComponentType("pgc.param","Parameter");y.short_name="Parameter",y.selector="pgcparam",a.addComponentType(y);var w=new PgComponentType("pgc.use","Use component");w.short_name="Use comp.",w.selector="[data-pgc]",w.attribute="data-pgc",w.action=!0,w.not_main_type=!0,w.sections={"pgc.parameters":{name:"Options",fields:{"data-pgc":{type:"select",name:"Id",action:"element_attribute",attribute:"data-pgc",attribute_keep_if_empty:!0,validate:a.fieldIsRequired,placeholder:a.textForExample("my.poster"),can_add_items:!0,options:function(){return t.insight.ext.components.getComponents()}},"data-pgc-no-update":{type:"checkbox",name:"Don't update",action:"element_attribute",attribute:"data-pgc-no-update",empty_attribute:!0,value:"1",on_changed:function(e,a,n,o,i,r,s,c,l){if(n)t.showQuickMessage("The component <b>will not</b> be updated when component definition changes.",3e3);else{var p=getElementPgNode(e.data);p&&rt(p.clone(!0),l)&&t.showQuickMessage("Be careful, updating components <b>will change</b> this component instance.",4e3,!1,!0)}}}}}},a.addComponentType(w),r.push(w),w.meta={helptext:"Set element to be an instance of a component."};var k=new PgComponentType("pgc.section","Define section");k.short_name="Section",k.selector="[data-pgc-section]",k.attribute="data-pgc-section",k.action=!0,k.not_main_type=!0,k.sections={"pgc.section.parameters":{name:"Options",fields:{"data-pgc-section":{type:"text",name:"Name",action:"element_attribute",attribute:"data-pgc-section",attribute_keep_if_empty:!1,validate:a.fieldIsRequired,placeholder:a.textForExample("My section")}}}},k.on_action_added=k.on_action_removed=function(){t.showQuickMessage("Update whole project to activate sections changes.",3e3)},a.addComponentType(k),r.push(k),k.meta={helptext:"Components defined within the section element are listed under this section in LIB panel."};var C=new PgComponentType("pgc.field","Use editable area");C.short_name="Editable",C.selector="[data-pgc-field]",C.attribute="data-pgc-field",C.action=!0,C.not_main_type=!0,C.get_action_tag=m,C.sections={"pgc.field.parameters":{name:"Options",fields:{"data-pgc-field":{type:"select",name:"Field Id",action:"element_attribute",attribute:"data-pgc-field",attribute_keep_if_empty:!1,validate:a.fieldIsRequired,placeholder:a.textForExample("title"),can_add_items:!0,options:function(e,a){return t.insight.ext.components.getEditableFieldsForElement(a.data)}}}}},a.addComponentType(C),s.push(C),C.meta={helptext:"Use component field. This action is added automatically when components are used. <b>Removing this action will cause edits to be lost.</b>"};var A=new PgComponentType("pgc.lock","Lock area");A.short_name="Lock",A.selector="[data-pgc-lock]",A.attribute="data-pgc-lock",A.action=!0,A.not_main_type=!0,A.get_action_tag=function(){return'<i class="fa fa-lock"></i>'},a.addComponentType(A),s.push(A),A.meta={helptext:"Lock all elements inside the element, expect editable areas. This is similar to Content contributor mode."};var P=[],T=new PgComponentType("pgc.master","Set as master page");T.short_name="Master",T.selector="[data-pgc-set-master]",T.attribute="data-pgc-set-master",T.action=!0,T.not_main_type=!0,T.on_action_added=function(e,t){var a=t.getFileNode(),n=t.getProject();n?a&&n.updateTagsForFile(a):S()},T.on_action_removed=function(e,t){var a=t.getFileNode();if(a){var n=t.getProject();n&&n.updateTagsForFile(a)}},T.on_can_add_action=function(e,a,n){return"html"!=e.tagName?(t.showQuickMessage("<b>Wrong element!</b> Set master page actions on <b>the TOP node of the page</b> in the tree.",5e3,!1,!0),!1):n==T&&e.hasAttr("data-pgc-master")||n==E&&e.hasAttr("data-pgc-set-master")?(t.showQuickMessage("The page can't BE A MASTER and USE A MASTER at the same time.",5e3,!1,!0),!1):!0},T.meta={helptext:"Define the page as a master page that is used as a template for other pages."},a.addComponentType(T),P.push(T);var S=function(){t.showAlert("<p>Master pages work with Projects. To use Master pages open the folder where your pages are located with <b>File -&gt; Open project</b>.</p>","Master pages and components require projects")},E=new PgComponentType("pgc.master.use","Use master page");E.short_name="Use master",E.selector="[data-pgc-master]",E.attribute="data-pgc-master",E.action=!0,E.not_main_type=!0,E.sections={"pgc.master.use.parameters":{name:"Options",fields:{"data-pgc-master":{type:"select",name:"Master page",action:"element_attribute",attribute:"data-pgc-master",attribute_keep_if_empty:!1,validate:a.fieldIsRequired,placeholder:a.textForExample("master.html"),can_add_items:!0,options:function(){return t.insight.ext.components.getMasterPages()}}}}},E.on_action_added=function(e,t){var a=t.getProject();if(a){var n=t.getFileNode();n&&a.updateTagsForFile(n)}else S();Lt(!0)},E.on_action_removed=function(e,t){var a=t.getFileNode();if(a){var n=t.getProject();n&&n.updateTagsForFile(a)}Lt(!0)},E.on_can_add_action=T.on_can_add_action,E.meta={helptext:"Select which master page will be used as the template for this page."},a.addComponentType(E),P.push(E);var x=[],F=new PgComponentType("pgc.partial.save","Save partial");if(F.short_name="Partial",F.selector="[data-pgc-save-partial]",F.attribute="data-pgc-save-partial",F.action=!0,F.not_main_type=!0,F.sections={"pgc.save.partial.parameters":{name:"Options",fields:{"data-pgc-save-partial":{type:"text",name:"File",action:"element_attribute",attribute:"data-pgc-save-partial",attribute_keep_if_empty:!1,validate:a.fieldIsRequired,file_picker:!0,file_picker_save:!0,file_picker_no_url:!0,file_picker_no_proxy:!0},"data-pgc-save-partial-content":{type:"checkbox",name:"Save only element's content",action:"element_attribute",attribute:"data-pgc-save-partial-content",empty_attribute:!0,value:"1"}}}},a.addComponentType(F),x.push(F),F.meta={helptext:"Save the element HTML code into a specified file when the page is saved."},i()){var j=new PgFrameworkLibSection("pg.components.master","Master pages");j.setComponentTypes(P),a.addActionsSection(j),j=new PgFrameworkLibSection("pg.components","Components"),j.setComponentTypes(r),a.addActionsSection(j),j=new PgFrameworkLibSection("pg.components.editable","Editable areas"),j.setComponentTypes(s),a.addActionsSection(j),j=new PgFrameworkLibSection("pg.components.partials","Partials"),j.setComponentTypes(x),a.addActionsSection(j)}var D,M=function(e){(!D||D&&!D.getProject())&&(D=new PgResourceEditor(e)),D.show()};a.on_project_menu=function(){var e=[];return e};var O=function(e,t){e?t.addTag(new CrsaFileTag("Master","primary","This is a master page.","clone")):t.removeTag("Master")},I=function(e,t){e?t.addTag(new CrsaFileTag("UseMaster","info","This page uses the master page "+e+".","clone")):t.removeTag("UseMaster")},N=function(e,t){e?t.addTag(new CrsaFileTag("DefC","primary","Components are defined on this page","cube")):t.removeTag("DefC")},U=function(e,t){e?t.addTag(new CrsaFileTag("UseC","info","Components are used on this page","cube")):t.removeTag("UseC")},Q=function(e,a){var n=null;e.forEachOpenPage(function(e){n=e,a&&a(e),a=null}),n||t.showAlert("<p>Updating the whole project needs at least one page from the project to be open in Pinegrow.</p><p><b>Open any editable page from the project</b> and run this action again.</p>","At least one page needs to be open.")},L=function(e){if(e&&e.framework){var t=e.getProjectInfo(),a=t.getSetting("project_resources"),n=e.framework;if(n.resources.clear(),a)for(var o=0;o<a.length;o++){var i=a[o].url,r=i;crsaIsAbsoluteUrl(i)||(r=e.getAbsoluteUrl(i));var s=a[o].footer||!1,c="auto"==a[o].type?"":a[o].type;if(r){var l=new PgComponentTypeResource(r);l.footer=s,l.relative_url=i,l.source=r,c&&(l.type=c),n.resources.add(l)}}}},R=function(e,a,n){var o=[],i={},r=[],s={},c={"default":[]},l=["default"];e.forEachEditableFile(function(t,a,n,p){for(var d=K(t,r,e),u=0;u<d.components.length;u++)if(d.components[u].type in i)n.warnings.push("Component <b>"+d.components[u].type+"</b> is <b>already defined</b> in "+e.getRelativePath(i[d.components[u].type].sourceFile)+".");else{o.push(d.components[u]),i[d.components[u].type]=d.components[u];var m=d.components[u].add_to_section||"default";c[m]||(c[m]=[],l.push(m)),c[m].push(d.components[u])}d.master&&(d.master.file=t.getFileNode(),d.master.image=ut(t,e),s[d.master.type]=d.master),U(d.used_component_types.length,p),N(d.components.length,p),O(d.master,p),I(d.use_master,p),t.setSyntaxErrorIndicator(t.sourceNode.validateTree().length>0,p,e),e.updateTagsForFile(p),a(t,n)},function(){var i=e.getName(),r=t.findFrameworkByKey(i),p=!1;r||(r=new PgFramework(i,i),p=!0),r.auto_updatable=!0,r.removeAllComponents(),r.master_pages=s,r.preview_images_base="previews";for(var d=0;d<o.length;d++)r.addComponentType(o[d]);for(var d=0;d<l.length;d++){var u=new PgFrameworkLibSection(e.getName()+"."+l[d],"default"==l[d]?e.getName():l[d]);u.setComponentTypes(c[l[d]]),r.addLibSection(u)}p&&t.addFramework(r,-1e3),e.framework=r,r.project=e,L(e),n||t.frameworksChanged(),r.components_loaded=!0,t.showQuickMessage("Found "+o.length+" components in "+e.getName()+"."),a&&a(e,r)},"Looking for components...")},W=function(e,t){return e.definition_code==t.definition_code&&e.code==t.code&&H(e,t)},H=function(e,t){return!(e.type!=t.type||e.name!=t.name||e.selector!=t.selector||e.parent_selector!=t.parent_selector||e.preview_image!=t.preview_image||e.button_image!=t.button_image||e.auto_update!=t.auto_update||e.description!=t.description)},q=function(e,t){t.name=e.name,t.selector=e.selector,t.parent_selector=e.parent_selector,t.code=e.code,t.definition_code=e.definition_code,t.definition_attributes=e.definition_attributes,t.preview_image=e.preview_image,t.button_image=e.button_image,t.description=e.description,t.component_fields=e.component_fields,t.component_repeat_fields=e.component_repeat_fields,t.auto_update=e.auto_update},B=function(e,a){var n=a.getName(),o=t.findFrameworkByKey(n);if(!o)throw"No framework!";for(var i=[],r=!1,s=K(e,i,a),c=0;c<s.components.length;c++){var l=s.components[c],p=o.getComponentType(l.type);if(p)W(p,l)||(q(l,p),r=r||!H(p,l),t.showQuickMessage("Component "+l.name+" changed."));else{o.addComponentType(l);var d=a.getName()+"."+(l.add_to_section||"default"),u=o.getLibSection(d);u||(u=new PgFrameworkLibSection(d,l.add_to_section||a.getName()),o.addLibSection(u)),u.addComponentType(l),r=!0,t.showQuickMessage("Component "+l.name+" added.")}}s.master&&(o.master_pages[s.master.type]=s.master),r&&t.frameworksChanged()},V=function(e,t,a,n){st(e,t,null,!1,a,n)};a.changeComponentDefinitionsToComponentInstances=function(e){e.walkSelfAndChildren(function(e){var t=e.getAttr("data-pgc-define");t&&(e.removeAttrIfStartsWith("data-pgc-define"),e.setAttr("data-pgc",t));var a=e.getAttr("data-pgc-edit"),n=null;if(a){var o=f(a);e.removeAttrIfStartsWith("data-pgc-edit"),e.setAttr("data-pgc-field",o.name),n=o.name}if(e.hasAttr("data-pgc-repeat")){var i=e.getAttr("data-pgc-repeat")||n;e.removeAttrIfStartsWith("data-pgc-repeat"),n||e.setAttr("data-pgc-field",i)}if(e.hasAttr("data-pgc-optional")){var r=e.getAttr("data-pgc-optional")||n;e.removeAttrIfStartsWith("data-pgc-optional"),n||e.setAttr("data-pgc-field",r)}return e.hasAttr("data-pgc-section")&&e.removeAttr("data-pgc-section"),!0})};var G=function(e){var t=e.getAttrList(),a={};return t.forEach(function(e){e.name.startsWith("data-pgc-define")&&(a[e.name]=e.value)}),a},K=function(e,t,i,r){var s={components:[],master:null,use_master:null,used_component_types:[]},c=function(e){var t=e.closest("[data-pgc-section]");return t?t.getAttr("data-pgc-section"):void 0},l=e.sourceNode.findOne("html");l&&(s.master=l.hasAttr("data-pgc-set-master"),s.use_master=l.getAttr("data-pgc-master"));var p=[];s.master&&!r&&p.push(e.sourceNode),e.sourceNode.walk(function(e){var t=e.getAttr("data-pgc-define");null===t||r&&r!=t||p.push(e);var a=e.getAttr("data-pgc");return a&&s.used_component_types.indexOf(a)<0&&s.used_component_types.push(a),!0});for(var d=0;d<p.length;d++){var u=p[d]==e.sourceNode,m=p[d].clone(!0),g=u?"master."+e.name:m.getAttr("data-pgc-define"),h=u?e.name:m.getAttr("data-pgc-define-name")||g,v=m.getAttr("data-pgc-define-selector"),b=G(m);if(u){for(var _=m.find("[data-pgc-define]"),y=0;y<_.length;y++)a.changeComponentDefinitionsToComponentInstances(_[y]);m.removeAttrIfStartsWith("data-pgc-section",!0)}m.removeAttrIfStartsWith("data-pgc-define",!1);for(var w=m.find("pgcparam"),y=0;y<w.length;y++)w[y].remove();if(g){var k=new PgComponentType(g,h);if(k.definition_code=m.toStringOriginal(!0),k.definition_attributes=b,v||m.setAttr("data-pgc",g),u){var C=m.findOne("html");C.removeAttr("data-pgc-set-master"),C.setAttr("data-pgc-master",e.name),k.master_page_source_node=m,k.master_page_url=e.url}k.sourceFile=e.localFile||e.url,k.sourceUrl=e.url,k.selector=v||'[data-pgc="'+g+'"],[data-pgc-define="'+g+'"]',k.tags="block",k.priority=10,k.is_smart_component=!0,k.auto_update="false"!=p[d].getAttr("data-pgc-define-auto-update"),k.add_to_section=c(p[d]);var A=n.join(i.getDir(),"previews",g+".png");"file"==crsaIsFileOrDir(A,o)&&(k.preview_image=g+".png",k.button_image=p[d].hasAttr("data-pgc-define-photo-preview-only")?null:k.preview_image),k.description=p[d].getAttr("data-pgc-define-description"),k.component_fields={},k.component_repeat_fields={};for(var P=function(e){return e.hasAttr("data-pgc-define")},T=m.findIncludingSelf("[data-pgc-edit]",!1,P),S=0;S<T.length;S++){var E=T[S].getAttr("data-pgc-edit"),x=f(E);x.selector=T[S].getAttr("data-pgc-edit-selector");var F=T[S].getAttr("data-pgc-edit-classes");x.classes=crsaSplitAndTrimList(F),x.bckimage=T[S].hasAttr("data-pgc-edit-bckimage");var j=T[S].getAttr("data-pgc-edit-types");j&&(x.types=crsaSplitAndTrimList(j)),x.name&&(T[S].setAttr("data-pgc-field",x.name),k.component_fields[x.name]=x),T[S].removeAttrIfStartsWith("data-pgc-edit")}for(var D=m.findIncludingSelf("[data-pgc-repeat]",!1,P),S=0;S<D.length;S++){var M=D[S].getAttr("data-pgc-field")||D[S].getAttr("data-pgc-repeat");M&&(D[S].setAttr("data-pgc-field",M),D[S].removeAttrIfStartsWith("data-pgc-repeat"),k.component_repeat_fields[M]=!0,M in k.component_fields?k.component_fields[M].repeat=!0:k.component_fields[M]={name:M,content:!1,attrs:[],classes:[],repeat:!0})}for(var O=m.findIncludingSelf("[data-pgc-optional]",!1,P),S=0;S<O.length;S++)if(!O[S].hasAttr("data-pgc-optional-restore")){var M=O[S].getAttr("data-pgc-field")||O[S].getAttr("data-pgc-optional");M&&(O[S].setAttr("data-pgc-field",M),O[S].removeAttrIfStartsWith("data-pgc-optional"),M in k.component_fields?k.component_fields[M].optional=!0:k.component_fields[M]={name:M,content:!1,attrs:[],classes:[],repeat:!0,optional:!0})}u||a.changeComponentDefinitionsToComponentInstances(m),k.code=m.toStringOriginal(!0),u?s.master=k:s.components.push(k);var I=i.getProjectInfo(),N=I.getSetting("project_resources");if(N)for(var y=0;y<N.length;y++){var U=N[y].url,$=U;crsaIsAbsoluteUrl(U)||($=i.getAbsoluteUrl(U));var Q=N[y].footer||!1;if($){var L=new PgComponentTypeResource($);L.footer=Q,L.relative_url=U,L.source=$,k.addResource(L)}}}}return s},J=function(e,t,a){var n=new mt,o=a.getComponentTypesInformation();e.forEachEditableFile(function(t,a,i){t.openedInEditor||t.setComponentTypesInformation(o),st(t,e,null,!1,n)&&(i.changed=!0),a(t,i)},function(){t&&t(),gt(n),n.show()},"Updating components...")},Y=function(e){if(e.startsWith("/"))try{return new RegExp(e.replace(/\//g,""),"")}catch(t){}return null},z=function(e,t,a){var n=t.name;a[n]||(a[n]={items:[],count:0});var o={restored:!1};t.content&&(o.html_content=e.html());for(var i=0;i<t.attrs.length;i++)o[t.attrs[i]]=e.getAttr(t.attrs[i]);o.classes={};for(var r=(t.classes,e.getClasses()),s=0;s<t.classes.length;s++){var c=Y(t.classes[s]);if(c)for(var l=0;l<r.length;l++)r[l].match(c)&&(o.classes[r[l]]=!0);else o.classes[t.classes[s]]=e.hasClass(t.classes[s])}t.bckimage&&(o.bckimage=e.getInlineStylePropertyValue("background-image",!0)),a[n].items.push(o)},X=function(e,t,a){var n=t.name;if(n&&a[n]){var o=a[n].count;o>=a[n].items.length&&(o=0);var i=a[n].items[o];t.content&&i.html_content&&e.html(i.html_content);for(var r=0;r<t.attrs.length;r++)i[t.attrs[r]]&&e.setAttr(t.attrs[r],i[t.attrs[r]]);for(var s=(t.classes,e.getClasses()),c=[],l=0;l<t.classes.length;l++){var p=Y(t.classes[l]);if(p){for(var d=0;d<s.length;d++)s[d].match(p)&&e.removeClass(s[d]);c.push(p)}else i.classes[t.classes[l]]?e.addClass(t.classes[l]):e.removeClass(t.classes[l])}if(c.length)for(var d=0;d<c.length;d++)$.each(i.classes,function(t,a){t.match(c[d])&&a&&e.addClass(t)});t.bckimage&&i.hasOwnProperty("bckimage")&&e.setInlineStylePropertyValue("background-image",i.bckimage,!0),i.restored=!0,o++,a[n].count=o}},Z=function(e,t){for(var a=null,n=0;n<e.children.length;n++)e.children[n].comment&&e.children[n].attributes.indexOf("[Pinegrow components saved data")>=0&&(a=$.trim(e.children[n].attributes.replace(/\[Pinegrow components saved data[^\]]*\]/,"").replace(/\-\-$/,"")),a=a.replace(/\[\[\[\-\-/g,"<!--").replace(/\-\-\]\]\]/g,"-->"),t&&e.children[n].remove());return a},et=function(e){var t=[];e.walkSelfAndChildren(function(e){return e.comment&&e.attributes.indexOf("[Pinegrow components saved data")>=0&&t.push(e),!0});for(var a=0;a<t.length;a++)t[a].remove();return t.length},tt=function(e){var a;return t.makeChanges(e,null,"Clear saved unused edits",function(){a=et(e.sourceNode)}),a},at=function(e,t){return t.component_fields&&e in t.component_fields?t.component_fields[e]:null},nt=function(e,t){e.walkSelfAndChildren(function(a){return a!=e&&(a.hasAttr("data-pgc")||a.hasAttr("data-pgc-define"))?"skip_children":t(a)})},ot=function(e,t,a,n,o,i){var r={},s={},c={},l=0,p=[],d="";o=o||{saved:0,deleted:[]};var m=Z(e,!0),g=[];if(m){var f=new pgParser;f.assignIds=!1,f.parse(m);for(var h=0;h<f.rootNode.children.length;h++){var v=f.rootNode.children[h],b=v.getAttr("data-pgc-field");if(b){var _=at(b,a);if(_&&_.optional)continue}g.push(v)}}for(var h=0;h<g.length;h++)e.append(g[h]);nt(e,function(e){for(var t=0;u>t;t++){var n="data-pgc-field"+(0==t?"":"-"+t),o=e.getAttr(n);if(o){var i=at(o,a);i?(z(e,i,r),i.optional&&(c[o]=!0)):(d+=e.toStringOriginal(!0),l++,p.push({field_id:o,node:e}));var m=a.component_repeat_fields&&a.component_repeat_fields[o]?o:null;m&&(s[m]||(s[m]=0),s[m]++)}}return!0},a.master_page_url||!1);for(var h=0;h<g.length;h++)g[h].remove();var y=[];nt(t,function(e){var t=e.getAttr("data-pgc-field");if(t&&s[t]){for(var o=1;o<s[t];o++){var i=e.clone();i.insertAfter(e)}s[t]=0}for(var o=0;u>o;o++){var l="data-pgc-field"+(0==o?"":"-"+o),p=e.getAttr(l);if(p){var d=at(p,a);d&&(X(e,d,r),d.optional&&(c[p]||n||y.push(e)))}}return!0},a.master_page_url||!1);for(var h=0;h<y.length;h++)y[h].remove();if(l&&!i){var w="[Pinegrow components saved data - this data is no longer used in the component. We're saving it just in case. Clear this with Components -> Clear saved unused edits]",a="<!--"+w+d.replace(/\<\!\-\-/g,"[[[--").replace(/\-\-\>/g,"--]]]")+"-->";t.append(pgCreateNodeFromHtml(a)),o.saved=l,o.deleted_areas=p}return o},it=function(e,a,n,o,i,r,s,l){var p={refresh_page:!1,changed:!1,saved:0,$new_el:null,deleted_areas:null};if(!a.auto_update&&!s)return p;var d=t.getCodeFromDefinition(a),u=pgCreateNodeFromHtml(d);ot(e,u,a,i,p,l),n&&n.callFrameworkHandler("on_component_updated",u,null,a);var m=u.toStringOriginal(!0);if(e.toStringOriginal(!0)!=m)if(p.changed=!0,r)u.remove();else{e.replaceWith(u,!0);var g=null,f=null;if(n&&n.openedInEditor)if(g=e.get$DOMElement(n.get$Html())){var h=n.getViewHTMLForElement(u);f=$(h),t.isElementSelected(g)&&(c=f);var v=t.isElementOrDescendantSelected(g);g.replaceWith(f),f.attr("data-pg-tree-id",g.attr("data-pg-tree-id")),o.push(f),p.$new_el=f,v&&t.selectElement(f)}else p.refresh_page=!0;e.remove()}else u.remove();return p},rt=function(e,t){var a=e.getAttr("data-pgc");if(a){var n=t.getTypeDefinition(a);if(n)return it(e,n,null,[],!1,!0).changed}return!1},st=function(e,a,n,o,i,r){var s=!1,l=!1,p=0,d=0;c=null,o||"1"!=t.getSetting("pgc-ignore-optional","0")||(o=!0,t.showQuickMessage("Optional areas are ignored."));var u=[];i=i||new mt,e.openedInEditor&&willMakeChange(e.$iframe,"Update components");var m=i.on_before_update||i.on_before_update_master||!1;completion_status="done";var g=function(){s?e.openedInEditor&&(didMakeChange(e.$iframe),l?e.refresh():(u.length&&t.updateTreeMultiple(u),c&&t.selectElement(c)),e.refreshDisplay()):e.openedInEditor&&e.undoStack.remove(),r&&r(s,completion_status)},f=function(){n||(n=e.sourceNode);var t=[];n.walkSelfAndChildren(function(a){if(a.isElement){var n=null,o=a.getAttr("data-pgc");if(!a.hasAttr("data-pgc-define")&&o){if(a.hasAttr("data-pgc-no-update"))return!0;n=e.getTypeDefinition(o)}n&&t.push({c:n,node:a,comp_type:o})}return!0});var a=function(n){if(n<t.length){{var r=t[n].node,c=t[n].c;t[n].comp_type}d++;var f=!0,h=function(t){var a=it(r,c,e,u,o,null,null,t);s=s||a.changed,p+=a.saved,i.saved+=p,a.refresh_page&&(l=!0)},v=it(r,c,e,u,o,!0);if(v.changed)if(m){var b=!1;i.on_before_update&&(b=!0,i.on_before_update(r,c,v,function(e){switch(e){case"update":case"update-delete":h(!0);break;case"update-save":h();break;case"skip":break;case"stop":return completion_status="stop",g(),void 0}a(n+1)})),b||(h(),a(n+1))}else h();else f=!1,m&&a(n+1)}else g()};if(m)a(0);else{for(var r=0;r<t.length;r++)a(r);g()}},h=function(){dt(e,a,i)&&(s=!0,l=!0)};if(!n)if(m)if(i.on_before_update_master){var v=dt(e,a,i,!1,!0);v?i.on_before_update_master(e,v.master_def,v,function(e){switch(e){case"update":h(),f();break;case"skip":f();break;case"stop":return completion_status="stop",g(),void 0}}):f()}else h(),f();else h();return m||f(),s},ct=function(e,a,n){if(!e)return t.showQuickMessage("You have to open the page in order to update the screenshot"),!1;var o=ut(e,a);return n||!crsaIsFileExist(o)?(t.takePhotoOfPage(e,o,function(){t.showQuickMessage("Screenshot updated successfuly")}),!0):(t.showQuickMessage("Screenshot not updated"),!1)},lt=function(e){if(e){var t=e.sourceNode.findOne("html");return t?t.hasAttr("data-pgc-set-master")?!0:!1:!1}},pt=function(e,t,a){var n=e.sourceNode.findOne("html");if(n){if(!t.framework)return null;var o=t.framework.master_pages,i=n.getAttr("data-pgc-master");if(i){var r="master."+i;if(r in o)return o[r];a&&a.addError("Page <b>"+e.name+"</b>: master page <b>"+i+"</b> not found.")}}return null},dt=function(e,a,n,o,i){var r=pt(e,a,n);if(r){var s=r.master_page_source_node.clone();s.setDocument(s);var c=ot(e.sourceNode,s,r,o);if(c&&(c.master_def=r),e.sourceNode.toStringOriginal(!0)!=s.toStringOriginal(!0))return i?(s.remove(),c):(e.sourceNode.remove(),e.sourceNode=s,t.fixLinks(a,e,r.master_page_url,e.url,function(e){e&&t.showQuickMessage("This page has broken links")},!1,!0),c)}return!1};a.on_project_loaded=function(e,a){"1"==t.getSetting("pgc-auto-reload","1")?R(a):It()},a.on_project_refreshed=function(e,a){"1"==t.getSetting("pgc-auto-reload","1")?R(a):It()},a.on_project_closed=function(){Lt(!1)},a.reloadProjectAndUpdateComponents=function(){t.stats.using("components.updateproject"),Lt(!1),Vt(function(e){Q(e,function(a){e.reload(function(){e.showProjectExplorer($("#crsa-project")),t.showNotice('<p><b>Update whole project</b> will go through <b>ALL</b> editable files (HTML, HTM, or file types listed in Editable file types in Support -&gt; Settings) in your project and apply changes to these files.</p><p><b>Changed files will not be saved.</b> Changed files will be marked in the <b>Project view</b> with <b><i class="fa fa-asterisk" style="color:#444;"></i></b> icon.<ul><li><b>Click on file</b> in PRJ view to open the changed file</li><li><b>Right-click</b> on the file and choose <b>Save</b></li><li>Use <b>File -&gt; Save all</b> to save all changed files.</li></ul></p><p><b>Be careful:</b> this action can change lots of your files. It is strongly <b>recommended</b> that you use a <b>source versioning system</b> (like Git) for this project.</p>',"About updating project","comps-update-project",function(){R(e,function(){J(e,null,a)
})})})})})},i()&&(a.on_key_pressed=function(e,t,n){85==t.which&&t.pgCtrlKey&&(t.shiftKey?a.reloadProjectAndUpdateComponents():ft(),n.done=!0)});var ut=function(e,t){var a=require("path"),n=crsaRemoveExtFromUrl(e.name)+".png",o=a.join(t.getDir(),"screenshots");return o=a.join(o,n)},mt=function(){this.saved=0,this.errors=[],this.addError=function(e){this.errors.push(e)},this.getErrors=function(){return this.errors.length?"<ul><li>"+this.errors.join("</li><li>")+"</li></ul>":null},this.hasErrors=function(){return this.errors.length>0},this.show=function(e){this.hasErrors()?t.showAlert("<p>The following problems happened during the "+("stop"==e?"stopped ":"")+"update:</p>"+this.getErrors(),"Oops, the update didn't go smoothly"):"stop"==e?t.showQuickMessage("Components update was stopped."):t.showQuickMessage("Components refreshed and updated.")}},gt=function(e){e.saved&&t.showNotice("<p>Some editable areas were removed from component definitions (or their field ids were changed). To prevent the corresponding edits from being lost, the edits were saved in component instances in the form of special invisible HTML comments.</p><p><b>To show this data again</b> restore editable areas in component definition.</p><p><b>To remove saved data</b> on the selected page use <b>Components -&gt; Clear saved data</b>.</p>","Unused editable areas","pgc-saved-data",function(a){a||t.showQuickMessage(e.saved+" unused edits were saved in components.",3e3)})},ft=function(e){t.stats.using("components.quickupdate"),Vt(function(a){for(var n=t.getAllPages(),o=0;o<n.length;o++)a.isPageInProject(n[o])&&B(n[o],a);var i=new mt;i.on_before_update_master=i.on_before_update=function(e,t,a,n){var o=e instanceof CrsaPage,i=o?e.sourceNode.findOne("html"):e;if(a.deleted_areas){var r="<ul>";a.deleted_areas.forEach(function(e){var t=Ct(i,e.field_id);r+=t?'<li><b><a href="#" data-pg-select-element="'+t.getId()+'">'+e.field_id+"</a></b>":"<li><b>"+e.field_id+"</b>";var a=e.node.html();a.length&&(a=crsaGetSummaryStr(escapeHtmlCode(a),60,!0),r+=" | "+a),r+="</li>"}),r+="</ul>";var s=function(e){n(e)},c=o?"Master page and Child page have different editable areas":"Some information will be lost after update",l=o?"<p>Applying master page <b>"+t.name+"</b> to the child page <b>"+e.name+"</b> will delete the information in some of its editable areas because these editable areas don't exist in the master page anymore (did you rename field ids or select a different master page?):</p>"+r+"<p>How would you like to proceed?</p>":"<p>Updating this <b>"+t.name+"</b> component instance (see selected element) will delete the information in some of its editable areas because these editable areas don't exist in the new component definition anymore (did you rename field ids or change component types?):</p>"+r+"<p>How would you like to proceed?</p>",p=null;p=o?[{label:"Do not update",action:"skip",func:s,tooltip:"Don't update this child page.",primary:!0},{label:"Update and discard",action:"update",func:s,tooltip:"Update the page and discard the unused information"},{label:"Stop update",action:"stop",func:s,tooltip:"Stop the process of updating components."}]:[{label:"Do not update",action:"skip",func:s,tooltip:"Don't update this component instance.",primary:!0},{label:"Update and save",action:"update-save",func:s,tooltip:"Deleted areas will be saved as HTML comment inside the instance. The information will be restored if the editable area comes back to the component. Use <b>Components -&gt; Clear saved data</b> to remove saved information.",primary:!0},{label:"Update and discard",action:"update-delete",func:s,tooltip:"Update the component and discard the unused information"},{label:"Stop update",action:"stop",func:s,tooltip:"Stop the process of updating components."}];var d=new PgAskAboutElements([i],l,c,p);d.show()}else n("update")},n=t.getAllPages().concat([]);var r="done",s=function(){n.length?V(n.shift(),a,i,function(e,t){"stop"==t&&(r="stop",n=[]),s()}):(i.show(r),gt(i),e&&e(r))};s()}),Lt(!1)};i()&&(a.on_page_changed=function(e,t){var a=t.closest("[data-pgc-define]");(a.length||t.closest("[data-pgc-set-master]").length)&&Lt(!0)},a.on_duplicate_element_async=function(e,n,o){var i;if(i=vt(n,e)){var r=ht(i,e);t.showAlert("<p>This element is the definition of the component <b>"+r+"</b>.</p><p>Would you like to duplicate the component definition - or - make the duplicated element an instance of this component?</p>","Duplicating component definition","Duplicate definition","Create instance",function(){o(n),t.showQuickMessage("Definition duplicated. Change component id if you want to keep both.")},function(){a.changeComponentDefinitionsToComponentInstances(n),o(n)})}else o(n)},a.on_before_delete_element_async=function(e,a,n){var o;if(o=vt(a,e)){var i=ht(o,e);t.showAlert("<p>This element is the definition of the component <b>"+i+"</b>.</p><p>Deleting the component definition will break all instances of this component.</p><p>Would you like to delete it?</p>","Deleting component definition","Do not delete","Delete definition",function(){n(null)},function(){n(a),t.showQuickMessage("Component definition was deleted.")})}else n(a)});var ht=function(e,t){var a=t.getTypeDefinition(e);return a?a.name:e},vt=function(e,t){return e.getAttr("data-pgc-define")},bt=function(e,a){willMakeChange(e.$iframe,"Restore master page optional areas");var n=new mt;dt(e,a,n,!0)?(didMakeChange(e.$iframe),e.refresh()):e.undoStack.remove(),t.showQuickMessage("Optional areas restored")};a.on_page_menu=function(e,a){var n=t.getCurrentProject();n&&n.isPageInProject(e)&&pt(e,n)&&(a.push({divider:!0}),a.push({label:"Restore optional areas",func:function(){bt(e,n)}}))};var _t=function(e){t.stats.using("components.gotodefinition"),e.sourceUrl?t.openOrShowPage(e.sourceUrl,function(a){t.setSelectedPage(a);var n=a.sourceNode.findOneWithAttrValue("data-pgc-define",e.type);if(n){var o=n.get$DOMElement(a.get$Html());o&&(t.selectElement(o,!0),t.scrollToElement(o))}},!1,!0):t.showQuickMessage("Sorry, don't know where the component is defined.",4e3,!1,"error")},yt=function(e,n){a.requireSelectedElement(function(a,o,i){var r=function(r){var s=e.definition_code,c=(new pgQuery).create(s,a);c.attr("data-pgc-define",r);var l=new pgQuery(o);canMakeChange(n?i.parent:i,"insert_element")&&t.makeChanges(a,o,"Duplicate definition",function(){n?c.insertAfter(l):l.append(c),t.setNeedsUpdate(n?o.parent():o)}),t.selectElement(c.$get(0),!0),t.showQuickMessage("Component definition duplicated."),Lt(!0)};t.showPrompt("<p>Enter the new component's id:</p>","Choose the unique id for the component",e.type,"",null,function(e){var n=a.getTypeDefinition(e);n?t.showAlert("Component definition with the id <b>"+e+"</b> already exists. Are you sure you want to use this id?","The id is not unique","Cancel","Use it!",function(){},function(){r(e)}):r(e)})})},wt=function(e){a.requireSelectedElement(function(a,n,o){t.makeChanges(a,n,"Make instance of",function(){if(o=o.get(0).pgel){for(var n=pgCreateNodeFromHtml(e.code),i=n.findIncludingSelf("[data-pgc-field]"),r=0;r<i.length;r++){var s=i[r].getAttr("data-pgc-field"),c=pgFindUniqueSelectorForElement(i[r],n,{tag:!0,path:!0});if(c){var l=o.find(c);console.log("Selector = "+c+" - found "+l.length);for(var p=0;p<l.length;p++)l[p].setAttr("data-pgc-field",s),console.log(l[p].getOpeningTag())}}o.setAttr("data-pgc",e.type),o.setAttr("data-pgc-dummy","hello");var d=[],u=it(o,e,a,d,!1);t.updateTreeMultiple(d),u.$new_el&&t.selectElement(u.$new_el)}})})},kt=function(e){return e.framework.project?!0:!1};i()&&(a.on_build_lib_actions_menu=function(e,t,a){kt(a)&&!St()&&(t.push({label:"Make selected an instance of <b>"+a.name+"</b>","class":"action-make-instance-of",kbd:null,manage_change:!0,action:function(){wt(a)}}),t.push({label:"Go to definition","class":"action-go-to-definition",kbd:null,manage_change:!0,action:function(){_t(a)}}),t.push({label:"Duplicate definition...","class":"duplicate-definition",kbd:null,manage_change:!0,action:function(){yt(a,!0)}}))},a.on_project_item_get_context_menu=function(e,a){var n=[];if(!D||D&&!D.getProject()){var o=t.getCurrentProject();D=new PgResourceEditor(o)}n.push({divider:!0,header:"Components"});return n.push({label:"Add to resources...",func:function(){D.requireFileFromUrl(a.url)}}),lt(e)&&n.push({label:"Update screenshot",func:function(){var a=t.getCurrentProject();ct(e,a,!0),t.cache_breaker++}}),n}),i()&&(a.on_build_actions_menu=function(e,a,i){if(!St()){var r=t.getCurrentProject();"html"==i.tagName&&r&&r.isPageInProject(e)&&pt(e,r)&&(a.push({type:"divider"}),a.push({type:"header",label:"Master page"}),a.push({label:"Restore optional areas",manage_change:!0,action:function(){bt(e,r)}}));var s=i.getAttr("data-pgc")||i.getAttr("data-pgc-define");if(s){var c=e.getTypeDefinition(s);c&&c.framework.project&&(a.push({type:"divider"}),a.push({type:"header",label:"Components"}),!i.getAttr("data-pgc")||c.auto_update&&!i.hasAttr("data-pgc-no-update")||a.push({label:"Update component instance","class":"action-update-component",kbd:null,manage_change:!0,action:function(){willMakeChange(e.$iframe,"Update component instance");var a=[],n=it(i,c,e,a,!1,!1,!0);n.changed?(didMakeChange(e.$iframe),a.length&&t.updateTreeMultiple(a),e.refreshDisplay(),t.showQuickMessage("Component instance updated!")):(e.undoStack.remove(),t.showQuickMessage("Component was not changed."))}}),a.push({label:"Go to definition","class":"action-go-to-definition",kbd:null,manage_change:!0,action:function(){_t(c)}}),a.push({label:"Duplicate definition...","class":"duplicate-definition",kbd:null,manage_change:!0,action:function(){yt(c,!0)}}),a.push({label:"Restore optional areas","class":"action-restore-optional",kbd:null,manage_change:!0,action:function(){st(e,c.framework.project,i,!0)}}),a.push({label:"Take component photo","class":"action-take-photo",kbd:null,manage_change:!0,action:function(e){var a=n.join(c.framework.project.getDir(),"previews"),i=n.join(a,s+".png");crsaCreateDirs(a,o),0==e.outerWidth()&&e.children().length&&(e=$(e.children().get(0))),t.takePhotoOfElement(e,400,i,function(){t.showQuickMessage("&lt;project&gt;/previews/<b>"+s+".png</b> saved."),t.cache_breaker++;var e=require("nw.gui");e.App.clearCache(),c.preview_image=s+".png",c.button_image=c.preview_image,c.definition_attributes&&"data-pgc-define-photo-preview-only"in c.definition_attributes&&(c.button_image=null),$("body").trigger("crsa-update-lib-display")})}}))}}}),t.loadProjectAsLibrary=function(e,a,o){var i=n.basename(e),r=t.findFrameworkByKey(i),s=crsaMakeUrlFromFile(e);if(r&&r.pluginUrl!=s)return t.showAlert("<p>Library <b>"+i+"</b> is already loaded.</p><p>Note that the library folder name is used as the name of the library. This name must be unique - only one library with a certain name can be loaded.</p>",i+" is already loaded"),a&&a(),void 0;r||(r=new PgFramework(i,i)),r.pluginUrl=s,t.addFramework(r,-1e3),t.frameworksChanged(),r.components_loaded=r.components_loaded||!1,r.on_init_plugin=function(a){if(r.components_loaded)a&&a(r);else{var n;t.stats.using("components.loadprojectaslibrary");var i=function(e){R(e,function(e,t){o&&o(e,t),a&&a(t)})},s=t.getCurrentProject();s&&s.getDir()==e?(n=s,n.framework=r,i(n)):(n=new CrsaProject,n.framework=r,n.fromFolder(e,function(e){i(e)},!0)),r.components_loaded=!0}},r.on_plugin_activated=function(e,t){r.on_init_plugin(t)};var c=t.getFrameworksListFromStorage();return c.indexOf(s)<0&&(c.push(s),crsaStorage.setValue("frameworks",c)),a&&a(r),r},t.selectAndLoadLibrary=function(e){crsaChooseFile(function(a,n){t.loadProjectAsLibrary(n,function(a){t.activateFrameworkInCurrentContext(a),e&&e(a)})},!1,!1,null,!0)};var Ct=function(e,t,a){a=a||0;var n=At(e,t);return a<n.length?n[a]:null},At=function(e,t){var a=[];return nt(e,function(e){if(e.isElement){var n=e.getAttr("data-pgc-edit");if(n){var o=f(n);o&&o.name==t&&a.push(e)}else e.getAttr("data-pgc-field")==t&&a.push(e)}return!0}),a},Pt=!1,Tt=function(e){Pt=e,t.reselectElement(),t.repaintTree()},St=function(){return Pt?!0:t.isContributorMode()};a.on_show_properties=function(e,n,o,i,r,s){var c=null,l=null;(l=qt(i))&&(null===a.on_can_make_change(e,i,"edit")?c="The element is fully editable":(n.splice(0,n.length),c="cc_mode"==l?"The element is not editable.":"The element is not editable because it is in the locked area."));var p=[];if(r)for(var d=0;d<r.length;d++)if(r[d].component_fields){var u=r[d],m={framework:u.framework,name:u.name,fields:{},component_fields:u.component_fields};p.push(m),c&&(c="Only certain properties of this element are editable.")}if(!p.length){var g=Bt(i,St()||!0,e);if(g){var f={};f[g.name]=g;var m={framework:a,name:"Editable properties",fields:{},component_fields:f};p.push(m),l&&(c="cc_mode"==l?"Only certain properties of this element are editable.":"Only certain properties of this element are editable because it is in the locked area.")}}if(p.length)for(var d=0;d<p.length;d++)if(p[d].component_fields){var h=!1,m=p[d];$.each(m.component_fields,function(a,n){var o=At(i,n.name);$.each(o,function(a){var i=1==o.length?"":" "+(a+1),r="."+(a+1);if(n.content){if(n.types&&n.types.length){var s={};s.name=n.name+i+" content",s.type="custom",s.show=function(a,o){var i=$('<div class="crsa-field"><label class="full-width">Add <nocap>to</nocap> '+n.name+":</label></div>");n.types.forEach(function(a){var r=ht(a,e),s=$('<button class="btn btn-primary btn-sm"><i class="fa fa-plus"></i> '+r+"</button>").on("click",function(i){i.preventDefault();var s=e.getTypeDefinition(a),c=getElementPgNode(o.data),l=getCodeFromDefinition(s),p=new PgApi,d=p.insert(l,c.getId(),"append",{scroll:!0,highlight:!0});d.length&&t.showQuickMessage(r+" was appended to "+n.name)});i.append(s)}),i.appendTo(a)}}else{var s={};s.name=n.name+i+" content",s.type="text",s.action="custom",s.get_value=function(e){var t=e.data,o=getElementPgNode(t),i=Ct(o,n.name,a);return i?i.html():null},s.set_value=function(e,o,i,r,s){t.willChangeDom();var c=e.data,l=getElementPgNode(c),p=Ct(l,n.name,a);if(p){p.html(o||"");var d=p.get$DOMElement();d&&(d.html(p.html(null,!0)),"change"==s&&t.updateTree(d))}return o}}s.on_can_make_change=function(){return!0},m.fields["pg.components.field."+n.name+r+".content"]=s,h=!0}for(var c=0;c<n.attrs.length;c++){var l=n.attrs[c];"wp-include-template-part-set"!=l&&(!function(e){var o={};o.name=n.name+i+" "+e,o.type="text",o.action="custom",o.options=function(o,i){var r=getElementPgNode(i.data),s=Ct(r,n.name,a);return t.insight.getValuesForAttribute(e,["img","script","link","iframe"].indexOf(s.tagName)>=0?s.tagName:null)},o.get_value=function(t){var o=t.data,i=getElementPgNode(o),r=Ct(i,n.name,a);return r?r.getAttr(e):null},o.set_value=function(o,i){var r=o.data,s=getElementPgNode(r),c=Ct(s,n.name,a);if(c){c.setAttr(e,i);var l=c.get$DOMElement();if(l){var p=i;"src"!=e&&"href"!=e||!p||(p=t.getProxyUrl(p)),l.attr(e,p)}}return i},o.on_can_make_change=function(){return!0},("src"==e||"href"==e)&&(o.file_picker=!0),m.fields["pg.components.field."+n.name+r+"."+e]=o}(l),h=!0)}for(var p=[],d=0;d<n.classes.length;d++){var u=Y(n.classes[d]);u||p.push({key:n.classes[d],name:n.classes[d]})}if(p.length){var s={};s.name=n.name+i+" classes",s.type="select",s.options=p,s.show_empty=!0,s.action="custom",s.multiple=p.length>1,s.get_value=function(e){var t=e.data,o=getElementPgNode(t),i=Ct(o,n.name,a),r=[];if(i){for(var s=0;s<p.length;s++)i.hasClass(p[s].key)&&r.push(p[s].key);if(r.length)return r.join(",")}return null},s.set_value=function(e,t){var o=e.data,i=getElementPgNode(o),r=Ct(i,n.name,a);if(r){for(var s=r.get$DOMElement(),c=0;c<p.length;c++)r.hasClass(p[c].key)&&(r.removeClass(p[c].key),s&&s.removeClass(p[c].key));if(t){var l=t.split(",");l.forEach(function(e){r.addClass(e),s&&s.addClass(e)})}}return t},s.on_can_make_change=function(){return!0},m.fields["pg.components.field."+n.name+r+".classes"]=s,h=!0}if(n.bckimage){var s={};s.name=n.name+i+" Bck. Image",s.type="text",s.action="custom",s.get_value=function(e){var t=e.data,o=getElementPgNode(t),i=Ct(o,n.name,a);return i?i.getInlineStylePropertyValue("background-image",!0):null},s.set_value=function(e,o){var i=e.data,r=getElementPgNode(i),s=Ct(r,n.name,a);if(s){s.setInlineStylePropertyValue("background-image",o,!0);var c=s.get$DOMElement();if(c){var l=t.getProxyUrl(o);l=crsaSetInlineStylePropertyValue(c.attr("style"),"background-image",l,!0),l?c.attr("style",l):c.removeAttr("style")}}return o},s.on_can_make_change=function(){return!0},s.file_picker=!0,m.fields["pg.components.field."+n.name+r+".bckimage"]=s,h=!0}})}),h&&n.unshift(m)}c&&s.append('<div class="alert alert-info">'+(Pt?"Content contributor mode is ON.<br><br>":"")+c+"</div>")},a.on_set_inline_style=function(e,t){t.css+="            html.pgc-mark-areas [data-pgc-define] {            box-shadow: 0 0 0px 1px rgba(0, 236, 255, 1);            }            html.pgc-mark-areas [data-pgc] {            box-shadow: 0 0 0px 1px rgba(255, 214, 0, 1);            }            html.pgc-mark-areas [data-pgc-field], html.pgc-mark-areas [data-pgc-edit] {            box-shadow: 0 0 0px 1px rgba(255, 214, 0, 0.3);            }            html.pgc-mark-areas[data-pgc-set-master] [data-pgc-edit] {            box-shadow: 0 0 0px 1px rgba(255, 214, 0, 1);            }            "};var Et=$('<li class="dropdown pgc-menu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">Components<b class="caret"></b></a>                        <ul class="dropdown-menu with-checkboxes">                            <li><a href="#" class="pgc-menu-quick-update">Quick update (only open pages)</a></li>                            <li><a href="#" class="pgc-menu-update-project">Update the whole project</a></li>                            <li><a href="#" class="pgc-menu-reload">Reload components from project</a></li>                            <li class="divider"></li>                            <li class="dropdown-header">Libraries</li>                            <li><a href="#" class="pgc-menu-edit-resources">Edit resources...</a></li>                            <li><a href="#" class="pgc-menu-refresh-libs">Refresh loaded libraries</a></li>                            <li><a href="#" class="pgc-menu-resources">Add/update resources from libraries...</a></li>                            <li class="divider"></li>                            <li class="dropdown-header">Tools</li>                            <li><a href="#" class="pgc-menu-auto-reload"><i class="fa fa-check"></i>Auto reload on project refresh</a></li>                            <li><a href="#" class="pgc-menu-mark"><i class="fa fa-check"></i>Mark components</a></li>                            <li><a href="#" class="pgc-menu-test-cm"><i class="fa fa-check"></i>Test Content contributor mode</a></li>                        <!--<li><a href="#" class="pgc-menu-ignore-optional"><i class="fa fa-check"></i>Ignore optional areas on update</a></li>-->                            <li><a href="#" class="pgc-menu-clear-saved-edits">Clear unused edits...</a></li>                            <li><a href="#" class="pgc-menu-help">Documentation</a></li>            </ul></li>');crsaAddKbd(Et.find(".pgc-menu-quick-update"),"CMD U"),crsaAddKbd(Et.find(".pgc-menu-update-project"),"SHIFT CMD U"),Et.find(".pgc-menu-quick-update").on("click",function(e){e.preventDefault(),ft()}),Et.find(".pgc-menu-update-project").on("click",function(e){e.preventDefault(),a.reloadProjectAndUpdateComponents()}),Et.find(".pgc-menu-reload").on("click",function(e){e.preventDefault(),Vt(function(e){R(e,function(){})})}),Et.find(".pgc-menu-resources").on("click",function(e){e.preventDefault(),t.showUpdateResourcesDialog(t.getSelectedPage(),t.getCurrentProject())}),Et.find(".pgc-menu-edit-resources").on("click",function(e){e.preventDefault(),M(t.getCurrentProject())}),Et.find(".pgc-menu-refresh-libs").on("click",function(e){e.preventDefault();var a=[],n=t.getCurrentProject();$.each(t.getFrameworks(),function(e,t){t.project&&t.components_loaded&&t.project!=n&&a.push(t)});var o=function(){if(a.length){var e=a.shift();e.project.reload(function(e){R(e,function(){o()},!0)})}else t.frameworksChanged()};o()}),Et.find(".pgc-menu-help").on("click",function(e){e.preventDefault(),t.openExternalUrl(t.pro_info_url)}),Et.find(".pgc-menu-apply-master").on("click",function(e){e.preventDefault();var a=t.getCurrentProject(),n=t.getSelectedPage();a&&n&&dt(n,a)}),Et.find(".pgc-menu-clear-saved-edits").on("click",function(e){e.preventDefault(),Vt(function(e){var a=t.showAlert("Would you like to clear saved unused edits in <b>the selected page</b> or from <b>the whole project</b>?","Where to clear?","Cancel","Selected page only",null,function(){var e=t.getSelectedPage();e&&(tt(e),t.showQuickMessage("Saved data cleared!"))}),n=$('<button class="btn btn-primary btn-sm">Whole project</button>');a.find(".modal-footer").append(n),n.on("click",function(n){n.preventDefault(),a.modal("hide"),e.forEachEditableFile(function(e,t,a){tt(e)&&(a.changed=!0),t(e,a)},function(){t.showQuickMessage("Saved data cleared!")},"Clearing saved unused edits...")})})});var xt=Et.find(".pgc-menu-mark"),Ft=xt.find("i"),jt=function(e){$.each(t.getAllPages(),function(t,a){var n=a.get$Html();n&&(e?n.addClass("pgc-mark-areas"):n.removeClass("pgc-mark-areas"))}),e?Ft.show():Ft.hide()};jt("1"==t.getSetting("pgc-mark-areas","1")),xt.on("click",function(e){e.preventDefault();var a="1"==t.getSetting("pgc-mark-areas","1");a=!a,jt(a),t.setSetting("pgc-mark-areas",a?"1":"0")});var Dt=Et.find(".pgc-menu-auto-reload"),Mt=Dt.find("i"),Ot=function(e){e?Mt.show():Mt.hide()},It=function(){t.showQuickMessage("Use <b>Components -&gt; Reload components from project</b> to reload components.",4e3)};Ot("1"==t.getSetting("pgc-auto-reload","1")),Dt.on("click",function(e){e.preventDefault();var a="1"==t.getSetting("pgc-auto-reload","1");a=!a,Ot(a),t.setSetting("pgc-auto-reload",a?"1":"0"),a||It()});var Nt=Et.find(".pgc-menu-test-cm"),Ut=Nt.find("i"),$t=function(e,a){e?(Ut.show(),a&&t.showNotice('<p>In <b>Content contributor mode</b> only editable areas can be edited, the rest of the page is locked.</p><p>Learn more about <a href="http://docs.pinegrow.com/editing/use-pinegrow-static-website-cms" class="external">using Pinegrow as CMS</a>.</p>',"About content contributor mode","pgc-content-contributor",function(e){e||t.showQuickMessage("Content contributor test mode is ON. Only editable areas can be edited.")})):(a&&t.showQuickMessage("Content contributor test mode is OFF."),Ut.hide())};$t(Pt),Nt.on("click",function(e){e.preventDefault();var t=Pt;t=!t,$t(t,!0),Tt(t)}),!t.isPRO()&&!t.isProTrialActive()||t.isContributorMode()||t.addPluginControlToTopbar(a,Et,!0);var Qt=$('<span class="update-components">Update '+crsaGetKbdDisplay("CMD U")+"</span>").on("click",function(e){e.preventDefault(),e.stopPropagation(),ft()});Qt.insertBefore(Et.find(">a>b"));var Lt=function(e){e?Qt.removeClass("update-components-hide"):Qt.addClass("update-components-hide")};a.setHasUpdates=Lt,Lt(!1),a.useMasterPage=function(e,t,a){var n=e.sourceNode.findOne("html");n.hasAttr("data-pgc-set-master"),n.removeAttr("data-pgc-set-master"),n.setAttr("data-pgc-master",a.name),dt(e,t)},a.updateEditableAreas=function(e){a.changeComponentDefinitionsToComponentInstances(e.sourceNode)},a.on_page_loaded=function(){jt("1"==t.getSetting("pgc-mark-areas","1"))},a.on_page_refreshed=function(){jt("1"==t.getSetting("pgc-mark-areas","1"))},a.on_page_saved=function(e){for(var a=e.sourceNode.find("[data-pgc-save-partial]"),n=0;n<a.length;n++){var o=a[n].getAttr("data-pgc-save-partial");try{var i=a[n].clone(!0);i.removeAttrIfStartsWith("data-pgc-save-partial",!0);var r;r=a[n].hasAttr("data-pgc-save-partial-content")?i.toStringContent(!0,t.getFormatHtmlOptions()):i.toStringOriginal(!0,t.getFormatHtmlOptions()),crsaWriteFileWithBackup(null,o,r,"utf8"),t.showQuickMessage("Partial <b>"+crsaGetSummaryStr(o,50)+"</b> saved!")}catch(s){t.showAlert("<p>Partial file "+o+" could not be saved: "+s+"</p>","Error saving partial file")}}};var Rt=function(e,t,a){var n=e.closest("[data-pgc]");return n?(a&&(a.element=n),t.getTypeDefinition(n.getAttr("data-pgc"))):void 0},Wt=function(e,t,a){var n=e.closest("[data-pgc],[data-pgc-define]");return n?(a&&(a.element=n),t.getTypeDefinition(n.getAttr("data-pgc")||n.getAttr("data-pgc-define"))):void 0},Ht=function(e,t){if(!e)return"";var a="<p>The following parts of <b>"+e.name+"</b> are editable:</p><ul>";if(e.content)if(e.types&&e.types.length){var n=e.types.map(function(e){var a=t.getTypeDefinition(e);return"<b>"+(a?a.name:e)+"</b>"});a+="<li>Component instances of "+n.join(", ")+" can be added and deleted from the content</li>"}else a+="<li>The content</li>";return e.attrs.length&&(a+="<li>Attributes: <b>"+e.attrs.join("</b>, <b>")+"</b></li>"),e.classes.length&&(a+="<li>Classes: <b>"+e.classes.join("</b>, <b>")+"</b></li>"),e.bckimage&&(a+="<li>Background image</li>"),a+="</ul>"},qt=function(e){return St()?"cc_mode":e.closest("[data-pgc-lock]")?"locked":!1};a.on_custom_tree_filter=function(e,t){if(St())try{e.get$Html().find("[data-pgc],[data-pgc-define],[data-pgc-edit],[data-pgc-field]").each(function(e,a){var n=a.getAttribute("data-pg-tree-id");if(n){t.selected_ids[n]=!0,t.changed||(t.changed=!0);var o=getDomElementPgNode(a),i=Bt(o,!0);if(i&&i.content){var r="*";i.types&&i.types.length&&(r=i.types.map(function(e){return'[data-pgc="'+e+'"],[data-pgc-define="'+e+'"]'}).join(",")),$(a).find(r).each(function(e,a){var n=a.getAttribute("data-pg-tree-id");n&&(t.selected_ids[n]=!0)})}}})}catch(a){}},a.on_can_make_change=function(e,a,n,o){if(e.getCurrentFrameworkHandlerReturnValue("on_can_make_change"))return e.getCurrentFrameworkHandlerReturnValue("on_can_make_change");var i=qt(a),r=!1,s="",c=t.getCurrentProject(),l={},p=null,u=i?Wt(a,e,l):Rt(a,e,l);if(St()&&vt(a)&&"delete_element"==n)return new PgEditException("<p>The element can't be deleted because it is the definition of the <b>"+u.name+"</b> component.</p><p>Deleting the component definition would break all instances of this component.</p>","This element can't be deleted");var m=["delete_element","duplicate_element"];u&&l.element==a&&m.indexOf(n)>=0&&(u=i?Wt(a.parent,e,l):Rt(a.parent,e,l)),c&&"add_action"==n&&"data-pgc-set-master"==o.attribute&&ct(e,c);var g=function(t,i){var c=a==i;if(c&&("add_class"==n||"remove_class"==n))if(t.attrs.indexOf("class")>=0)r=!0;else for(var l=0;l<t.classes.length;l++){var p=Y(t.classes[l]);if(p){if(o.match(p)){r=!0;break}}else if(o==t.classes[l]){r=!0;break}}c&&"attr"==n&&(t.attrs.indexOf(o)>=0?r=!0:s=1==t.attrs.length?"Only the attribute <b>"+t.attrs[0]+"</b> is editable.":"Only attributes <b>"+t.attrs.join(", ")+"</b> are editable.");var d=function(a){for(var n=e.getAllTypes(null,a,!0),o=0;o<n.length;o++)if(t.types.indexOf(n[o].type)>=0)return!0;return!1};if(t.content)if(c)if(t.types&&t.types.length)"insert_element"==n&&o&&o.inserted&&d(o.inserted)&&(r=!0);else{var u=["insert_element","edit_content","edit_code"];u.indexOf(n)<0?s="Content of the element can't be changed.":r=!0}else if(t.types&&a.parent==i){var u=["delete_element","duplicate_element"];u.indexOf(n)>=0&&d(a)&&(r=!0)}else r=!0;if(t.bckimage&&c&&"element_bckimage"==n&&(r=!0),t.repeat&&c&&("duplicate_element"==n||"delete_element"==n||"move_element"==n)&&(r=!0),t.optional&&c&&"delete_element"==n&&(r=!0),"insert_element"==n&&o&&o.moved){var m=o.moved,g=Bt(m);if(g&&g.repeat){var f=function(e,t){if(t){var a=Bt(t);return a&&a.name==e}return!1};(f(g.name,o.prev)||f(g.name,o.next))&&(r=!0)}}};if(u||c&&(u=pt(e,c)),u){var h=l.element||null,v=i?a.closest("[data-pgc-field],[data-pgc-edit]",h):a.closest("[data-pgc-field]",h),b=a==h;if(u.auto_update){if(h&&h.hasAttr("data-pgc-no-update"))r=!0;else if(v){var _=v.getAttr("data-pgc-field");if(!_&&i){var y=f(v.getAttr("data-pgc-edit"));y&&(_=y.name)}p=_&&u.component_fields?u.component_fields[_]||null:null,p?g(p,v):r=!0}}else r=!0;if(!r&&b&&(r=["delete_element","duplicate_element","move_element"].indexOf(n)>=0),r||"edit_code"!=n||(r=!0,t.showQuickMessage("Be carefull - you're editing a component instance!",3e3)),r||"html"!=a.tagName||("add_action"==n||"remove_action"==n?(o==T||o==E)&&(r=!0):"attr"==n&&o.startsWith("data-pgc-master")&&(r=!0)),r||!b||"add_action"!=n&&"remove_action"!=n||(o==d||o==w)&&(r=!0),r||!b||"attr"!=n||"data-pgc-no-update"!=o&&"data-pgc"!=o||(r=!0),!r)return St()?new PgEditException("<p>This element is not editable.</p>"+Ht(y,e),"This element is locked"):new PgEditException("<p>The element can't be changed because it is defined in component <b>"+u.name+"</b>.</p>"+Ht(p,e)+'<p>Choose "Go to component definition" to edit the component definition.</p>',"This element is locked",function(e){$('<button class="btn btn-default btn-sm" type="button">Go to component definition</button>').on("click",function(t){t.preventDefault(),_t(u),e.modal("hide")}).insertBefore(e.find(".btn.ok"))})}else if(i){var v=a.closest("[data-pgc-edit]");if(v){var y=Bt(v,!0);if(y)return g(y,v),r?null:new PgEditException("<p>This element is not editable.</p>"+Ht(y,e),"This element is locked")}}return!i||p||r||"remove_action"==n&&o==A?null:new PgEditException((Pt?"<p><b>Test Content contributor mode is ON.</b></p>":"")+'<p>The element is not editable.</p><p>Only elements marked with <i class="fa fa-pencil" style="color:#6cadd6;"></i> in the tree are editable.</p>',"This element is locked")};var Bt=function(e,a,n){var o=null,i=e.getAttr("data-pgc-field");if(i){var r={},s=Rt(e,e.getPage(),r);if(s){var o=at(i,s);if(o)return o}}if(a&&(o=f(e.getAttr("data-pgc-edit")),o.name||(o=null),o)){var c=e.getAttr("data-pgc-edit-classes");o.classes=crsaSplitAndTrimList(c),o.bckimage=e.hasAttr("data-pgc-edit-bckimage");var l=e.getAttr("data-pgc-edit-types");l&&(o.types=crsaSplitAndTrimList(l))}if(i&&n){var p=t.getCurrentProject();if(p&&p.isPageInProject(n)){var d=pt(n,p);if(d)return at(i,d)}}return o},Vt=function(e){var a=t.getCurrentProject();a?e(a):t.showAlert("<p>Components work with <b>Projects</b>. To use components open the folder where your pages are located with <b>File -&gt; Open project</b>.</p>","Components work with Projects")}})});