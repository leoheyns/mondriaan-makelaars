$(function(){$("body").one("pinegrow-ready",function(t,e){var n=new PgFramework("pg.asset.manager","Asset manager");e.addFramework(n),n.default=!0,n.show_in_manager=!1;var a=function(){var t,n="AIzaSyCTphlYszhVyhJKDwKgUDdl64PfPaXxXUI",a="Pinegrow web editor, asset manager.",o=a,s=null,i=function(t){var e=[];e.push("http://fonts.googleapis.com/css?family="),e.push(t.family.replace(/ /g,"+"));var n=t.variants.map(function(t){var e=u(t);return e["font-weight"]+("italic"==e["font-style"]?"italic":"")});return e.push(":"+n.join(",")),e.push("&subset="+t.subsets.join(",")),e.join("")},l=function(t){var e=[];return e.push("http://fonts.googleapis.com/css?family="),e.push(t.family.replace(/ /g,"+")),t.wanted_weights_and_style&&t.wanted_weights_and_style.length>0&&e.push(":"+t.wanted_weights_and_style.join(",")),t.wanted_subsets&&t.wanted_subsets.length>0&&e.push("&subset="+t.wanted_subsets.join(",")),e.join("")},r={},d=1,c=[],p=[],f=!1,h=function(){var t=$(this).closest("li"),e=p[parseInt(t.attr("data-index"))];$(this).is(":checked")?(r[e.family]=e,t.addClass("checked")):(r[e.family]&&delete r[e.family],t.removeClass("checked"))},u=function(t){var e=t.match(/([0-9]+)([a-z]*)/),n={};return e?(n["font-weight"]=e[1],n["font-style"]=e[2]?e[2]:"normal"):(n["font-weight"]="400","regular"==t?n["font-style"]="normal":"italic"==t&&(n["font-style"]="italic")),n},g=function(t){var e=t.split("-");return crsaCamelize(e[0])+("ext"==e[1]?" Extended":"")},v=function(e){var n=[],a=[],s=$(this).closest("li"),i=parseInt(s.attr("data-index")),l=t.closest(".gfonts-modal"),r=$(this).position().top-50,d=l.width()/2-t.width()/2;t.css("top",r),t.css("left",d),t.html(""),t.addClass("open");for(var c=p[i],f=$('<div class="advance-settings-content"></div>').appendTo(t),h=$('<div class="font-style"><h3>Styles</h3></div>').appendTo(f),v=$('<table width="100%" style="font-family:'+c.family+';"><tbody></tbody></table>').appendTo(h),m=v.find("> tbody"),y=c.variants,b=0;b<y.length;b++){var w=u(y[b]),T=$('<tr style="font-weight:'+w["font-weight"]+";font-style:"+w["font-style"]+';"></tr>').appendTo(m),k=$('<td width="30%"></td>').appendTo(T);F=$('<input data-font-weight="'+w["font-weight"]+'" data-font-style="'+w["font-style"]+'" type="checkbox">').appendTo(k),$("<span> "+w["font-weight"]+" "+crsaCamelize(w["font-style"])+"</span>").appendTo(k);var k=$('<td width="70%">'+o+"</td>").appendTo(T);F.change(function(){var t=$(this).attr("data-font-weight")+("italic"==$(this).attr("data-font-style")?"italic":"");if($(this).is(":checked"))n.indexOf(t)<0&&n.push(t);else{var e=n.indexOf(t);e>-1&&e<n.length&&n.splice(e,1)}});var x=w["font-weight"]+("italic"==w["font-style"]?"italic":"");c.wanted_weights_and_style&&c.wanted_weights_and_style.indexOf(x)>-1&&F.prop("checked",!0).change(),"400"==w["font-weight"]&&"normal"==w["font-style"]&&F.prop("checked",!0).change()}for(var _=$('<div class="font-charset"><h3>Character sets</h3></div>').appendTo(f),C=function(){var t=[],e=_.find('[type="checkbox"]');e.each(function(e,n){!$(n).is(":disabled")&&$(n).is(":checked")&&t.push($(n).attr("data-subset"))});var n=_.find('[data-subset="latin"]');return t.length>0?1==t.length&&"latin"==t[0]?(n.attr("disabled",""),t=[]):n.is(":disabled")&&(n.removeAttr("disabled"),n.is(":checked")&&t.push("latin")):n.prop("checked",!0).attr("disabled",""),t},S=c.subsets,b=0;b<S.length;b++){{var A=S[b],D=$('<span class="subset-option"></span>').appendTo(_),F=$('<input data-subset="'+A+'" type="checkbox">').appendTo(D);$("<span> "+g(A)+"</span>").appendTo(D)}"latin"==A&&(F.prop("checked",!0),F.attr("disabled","")),F.change(function(){a=C()}),c.wanted_subsets&&c.wanted_subsets.indexOf(A)>-1&&F.prop("checked",!0).change()}var P=$('<div class="footer-control clearfix"></div>').appendTo(t),j=$('<button type="button" class="btn btn-primary btn-sm">Accept</button>').appendTo(P),I=$('<button type="button" class="btn btn-sm">Cancel</button>').appendTo(P);j.click(function(e){e.preventDefault(),c.wanted_weights_and_style=n,c.wanted_subsets=a,s.find('[type="checkbox"]').prop("checked",!0).change(),t.removeClass("open")}),I.click(function(e){e.preventDefault(),t.removeClass("open")}),e.preventDefault()},m=function(t){var a=t.closest(".modal-body"),l=a.find("> div"),r=a.find(".loading-icon"),u=function(){if(!f){r.show();var e=20*(d-1),n=20*d;if(e>=p.length)return f=!0,r.hide(),void 0;n>=p.length&&(n=p.length,f=!0,r.hide());for(var a=e;n>a;a++){var l=$('<li data-index="'+a+'"></li>').appendTo(t),c=$('<input type="checkbox">').appendTo(l),u=$("head");u.append('<link href="'+i(p[a])+'" rel="stylesheet">');var g=$("<h3 class='font-preview' style='font-family:"+p[a].family+";'>"+o+"</h3>").appendTo(l),m=$('<i class="advance-settings-icon pull-right glyphicon glyphicon-cog"></i>').appendTo(g);$("<p class='more-info'><b>"+p[a].family+"</b>, category: "+p[a].category+"</p>").appendTo(l),c.change(h),m.click(v)}s=t}};a.on("scroll",function(){l.height()+l.offset().top<750&&!f&&(d++,u())}),c&&0!=c.length?s||u():$.ajax({type:"GET",url:"https://www.googleapis.com/webfonts/v1/webfonts",data:{key:n},success:function(t){c=t.items,p=c,u()},error:function(){e.showQuickMessage("There is a problem with calling google fonts")}})},y=function(t){var e=t.match(/family=([a-zA-Z\+]*)/);return e&&e.length>0?e[1].replace(/\+/g," "):null},b=function(t,n){var a=y(t.url);if(a){var o=$('<i class="glyphicon glyphicon-copy" title="Copy family name to clipboard"></i>').appendTo(n);o.click(function(t){t.preventDefault(),crsaCopyToClipboard(a),e.showQuickMessage("Font name copied to your clipboard...")})}},w=function(){d=1,f=!1,s=null,p=c};this.show=function(e){r={};var n=$('<div class="gfonts-modal"><p>Choose fonts you want to add to your page</p></div>'),i=$('<div class="row"></div>').appendTo(n),h=$('<div class="col-sm-6 col-xs-12"></div>').appendTo(i),u=$('<div class="col-sm-6 col-xs-12"></div>').appendTo(i),g=$('<form class="form-inline font-search"><div class="form-group"><label for="search-for-font">Search:</label><input type="search" class="form-control" placeholder="Search by font name..." style="margin: 10px 2px; min-width: 250px" id="search-for-font"></div></form>').appendTo(h),v=g.find("input"),y=$('<form class="form-inline font-preview-text"><div class="form-group"><label for="font-preview-text">Preview text:</label><input type="text" class="form-control" placeholder="Preview text..." style="margin: 10px 2px; min-width: 250px" id="font-preview-text"></div></form>').appendTo(u),T=y.find("input");makeAndShowDialog("Google fonts","Close","Save",n,function(){e&&e([])},function(){if(e){var t=[];for(var n in r)t.push({url:l(r[n]),name:r[n].family,action:b});e(t)}},null,!0);var k=$('<ul class="gfonts-list"></ul>').appendTo(n);$('<center class="loading-icon"><img src="lib/crsa/images/loading.GIF"></center>').appendTo(n),t=$('<div class="advance-settings"><div class="advance-settings-content"></div></div>').appendTo(n),w(),m(k),v.keyup(function(){v.val()?(d=1,f=!1,s=null,p=c.filter(function(t){return t.family?t.family.toLowerCase().match(v.val().toLowerCase()):void 0})):(w(),p=c),k.html(""),m(k)}),T.keyup(function(){T.val()?(o=T.val(),k.find("h3").html(o)):(o=a,k.find("h3").html(o))})},this.checkForLinks=function(t){var n=[];return e.goThroughAllForAttribute(t,"href",function(t,e,a){var o=a.match(/fonts.googleapis.com\/css/);if(t.is("link")&&o&&o.length>0){var s=y(a);s&&n.push({url:a,name:y(a),action:b})}}),n},this.addNotes=function(t){$('<span>Click on <i class="glyphicon glyphicon-copy"></i> icon to copy the family name to clipboard. Then paste it into the Font family property of the CSS rule.</span>').appendTo(t)}},o=function(){var t="Asset manager - BETA",o=new a,s=[],i=[],l=function(t){return t>-1&&t<s.length?(i.push(s[t]),s.splice(t,1),!0):!1},r=function(t){for(var e=t.map(function(t){return{url:t.url,type:"CSS",from:"Google font",info:t.name,action:t.action}}),n=[],a=0;a<s.length;a++){for(var o,l=!1,r=0;r<e.length;r++)if(s[a].info==e[r].info){l=!0,o=e[r],e.splice(r,1);break}l?(i.push(s[a]),n.push(o)):n.push(s[a])}s=$.merge(n,e)},d=function(){var t=e.getSelectedPage();if(!t)return e.showAlert("There is no open page"),void 0;var n=t.get$Html();e.makeChanges(t,n,"Add/Remove assets to/from page",function(){for(var e=0;e<i.length;e++)if("CSS"==i[e].type){var a=n.find('[href*="'+i[e].url+'"]');new pgQuery(a).remove()}for(var e=0;e<s.length;e++)"CSS"==s[e].type&&t.addStylesheet(s[e].url);$.fn.crsa("setNeedsUpdate",!0,t.get$Html())})};this.show=function(){var a=$("<div></div>"),i=$('<table class="assets-manager file-chooser table table-striped table-condensed table-hover"><thead><tr><td style="width:60%;"><label>Asset name</label></td><td><label>Type</label></td><td style="width:100px;"><label>More Info</label></td><td style="width:30px;"></td><td style="width:30px;"></td></tr></thead><tbody></tbody></table>').appendTo(a),c=i.find("tbody"),p=function(t){c.html("");for(var e=0;e<s.length;e++){var n=crsaGetSummaryStr(s[e].url,60),a=$('<tr data-index="'+e+'"></tr>').appendTo(c);$td=$('<td class="elm-url"><label>'+n+"</label></td>").appendTo(a),$td=$('<td class="elm-type">'+s[e].type+(s[e].from?"/"+s[e].from:"")+"</td>").appendTo(a),$td=$('<td class="more-info">'+s[e].info+"</td>").appendTo(a),$td=$('<td class="elm-action"></td>').appendTo(a),s[e].action&&s[e].action(s[e],$td),$td=$('<td class="elm-delete"><i class="glyphicon glyphicon-trash"></i></td>').appendTo(a);var o=$td.find("> .glyphicon");o.click(function(t){t.preventDefault(),a=$(this).closest("tr"),l(parseInt(a.attr("data-index")))&&p()})}t||d()},f=$('<p class="assets-notes"></p>').appendTo(a),h=$('<form class="form-inline load-files-folders" role="form"></form>').appendTo(a),u=$('<button type="submit" class="btn btn-default add-google-font">Add Google font</button>').appendTo(h);o.addNotes&&o.addNotes(f),u.click(function(t){t.preventDefault(),o.show(function(t){r(t),p()})});var g=function(){s=[];var t=e.getSelectedPage();if(t){var n=o.checkForLinks(t);r(n),p(!0)}};g(),n.on_page_refreshed=g,makeAndShowDialog(t,"Close",null,a,function(){},null,null,!0)}},s=new o;e.isContributorMode()||(n.on_page_menu=function(t,e){e.push({label:"Manage assets...",kbd:null,func:function(){s.show()}})})})});