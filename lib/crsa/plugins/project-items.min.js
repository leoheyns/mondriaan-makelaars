$(function(){$("body").one("pinegrow-ready",function(e,n){var t=new PgFramework("pg.project.items","Project items");n.addFramework(t),t.default=!0,t.show_in_manager=!1;var r=function(e){t.requireSelectedElement(e)},a=function(e,n,t){e&&(crsaTemplateBrowser=new CrsaProjectBrowser,crsaTemplateBrowser.title="Add a page to your project",crsaTemplateBrowser.intro="<p>Choose a page to add to your project:</p>",crsaTemplateBrowser.setProjects(e),crsaTemplateBrowser.selectedProject=n,crsaTemplateBrowser.onFileSelected=function(e,n){t(e,n)},crsaTemplateBrowser.show())},o=function(e,t){t=t||"",n.showPrompt("Name of the new folder","New folder",t,"Folder name",null,function(t){if(t.length){var r=require("path"),a=r.join(e,t);crsaIsFileExist(a)?n.showAlert("Folder/File with the same name (<b>"+t+"</b>) exists. Please choose a different name.","Folder/File with Same Name Found",null,"Ok",null,function(){o(e,t)}):(crsaCreateDirs(a),n.refreshCurrentProject())}else n.showAlert("Folder name should not be blank","Error",null,"Ok",null,function(){o(e,"")})})},i=function(e,t,r,a,o,s){s=s||t.name,n.showPrompt("Name of the new page","New page",s,"Page name",null,function(s){if(s.length){var l=crsaCombineCurrentUrlWith(e,s);if(r.getFileForUrl(l))s&&n.showAlert("The page <b>"+s+"</b> already exists. Please choose a different name.","File with Same Name Found",null,"Ok",null,function(){i(e,t,r,a,o,s)});else try{var u=t.copyFileToNewPath(crsaMakeFileFromUrl(l));n.openPage(u.url,function(e){n.fixLinks(r,e,t.url,u.url,function(){if(a==r){e.crsaProjectTemplate=o;var i=n.findFrameworkByKey("pg.components");i.useMasterPage(e,r,t),i.updateEditableAreas(e)}else e.crsaProjectTemplate=a;e.detectAndAddFrameworks(),e.save(function(){n.refreshCurrentProject(function(){e.refresh()})},!0,!1,!1,!0,!0)},!0)})}catch(c){n.showAlert(c,"Error")}}else n.showAlert("Filename should not be blank","Error",null,"Ok",null,function(){i(e,t,r,a,o,"")})})},s=function(e){var t=n.getCurrentProject();t.show_only_master_pages=!0;var r=t.getProjectInfo(),o=r.getSetting("template_framework_id"),s=n.projectTemplates.filter(function(e){return e.framework.type==o});s=s.length>0?s[0]:n.projectTemplates[0];var l=[t];n.isContributorMode()||(l=l.concat(n.projectTemplates)),a(l,s,function(n,r){i(e,n,t,r,s)})};t.on_project_menu=function(e,t){var r=[];return r.push({label:"Reload project",func:function(){n.refreshCurrentProject()}}),r.push({label:"Add new folder...",func:function(){o(t.getDir())}}),r.push({label:"Add new page...",func:function(){s(crsaMakeUrlFromFile(t.getDir()))}}),r.push({label:"Close project",func:function(){n.closeCurrentProject()}}),r},t.on_project_item_preview=function(e,t){var r=n.getMimeType(t.name);return r&&r.startsWith("image/")?'<img src="'+t.url+'" />':void 0},t.on_project_item_get_context_menu=function(e,t,a){var i=function(e){var t=n.getCrsaPageByUrl(e);return t?(t.close(),!0):!1},l=[];l.push({divider:!0,header:"Pages"}),t.isFile||(l.push({label:"Add new folder...",func:function(){o(t.path),n.stats.using("prj.newfolder")}}),l.push({label:"Add new page...",func:function(){s(t.url),n.stats.using("prj.newpage")}})),t.isEditable&&l.push({label:"Open",func:function(){n.openOrShowPage(t.url),n.stats.using("prj.openfile")}}),t.isEditable&&l.push({label:"Open as partial...",func:function(){new pgOpenPartialInContainer(t.url,null,!0);n.stats.using("prj.openpartial")}}),t.isFile&&l.push({label:"Open in code editor",func:function(){n.openFileInCodeEditor(t.path),n.stats.using("prj.editcode")}});var u=n.getCrsaPageByUrl(t.url)||a.getBackgroundPageForUrl(t.url);u&&l.push({label:"Save",func:function(){canSavePage(u)&&u.save(null,!0,!0,!1,!0)}}),l.push({label:"Duplicate...",func:function(){n.stats.using("prj.duplicate"),n.showPrompt("Name of the new file","Duplicate file",t.name,null,null,function(e){if(e.length&&e!=t.name)try{var r=a.getProjectInfo(),o=r.getSettingsForFile(t.path),i=t.duplicate(e);for(var s in o)r.setSettingForFile(i.path,s,o[s]);r.save();var l=function(){n.refreshCurrentProject()},u=n.getCrsaPageForUrl(i.url);if(u){var c=u.sourceNode.find("[data-pgc-define]");if(c.length>0){for(var f=[],p=0;p<c.length;p++)f.push(c[p].getAttr("data-pgc-define"));n.showAlert("<p>The page contains <b>component definitions</b> for components: "+f.join(", ")+".</p><p>Do you want to:<ul><li><b>Keep these definitions in the new page</b> (and have duplicate definitions, which you would need to fix later)<br />- or -</li><li><b>Replace component definitions with component instances in the new page</b>?</li></ul></p>","What to do with component definitions?","Keep definitions","Replace with instances",function(){l()},function(){n.findFrameworkByKey("pg.components").changeComponentDefinitionsToComponentInstances(u.sourceNode),u.save(),l()})}else l()}else l()}catch(d){n.showAlert(d,"Error")}else n.showQuickMessage("Nothing to do...")})}}),l.push({label:"Delete...",func:function(){n.showAlert("Are you sure you want to delete <b>"+t.name+"</b>?","Delete file/folder","No","Yes",null,function(){t.delete()?(i(t.url),n.showQuickMessage("<b>"+t.name+"</b> deleted successfuly."),n.refreshCurrentProject()):n.showQuickMessage("Failed to delete <b>"+t.name+"</b>.")}),n.stats.using("prj.delete")}}),l.push({label:"Rename...",func:function(){n.stats.using("prj.rename"),n.showPrompt("Enter the new file name","Rename file/folder",t.name,"New file name",null,function(e){if(e.length&&e!=t.name){var r=n.getCrsaPageByUrl(t.url);r&&r.save(null,!0);var o=function(){try{var r=a.getProjectInfo(),o=r.getSettingsForFile(t.path),s=t.rename(e);for(var l in o)r.setSettingForFile(s.path,l,o[l]);r.save(),n.showQuickMessage("<b>"+t.name+"</b> renamed successfuly."),i(t.url)&&s&&n.openOrShowPage(s.url,function(e){e.detectAndAddFrameworks(),n.updatePluginControlsForSelectedPage(e)}),n.refreshCurrentProject()}catch(u){n.showQuickMessage("Failed to rename <b>"+t.name+"</b>.")}};t.doesFileExistInSameDir(e)?t.isDirectoryInTheSameDir(e)?n.showAlert("Are you sure you want to overwrite <b>"+e+"</b>?","overwrite file","No","Yes",null,function(){o()}):n.showQuickMessage("You can't overwrite directory"):o()}else n.showQuickMessage("Nothing to do...")})}}),l.push({label:"Fix links...",func:function(){n.stats.using("prj.fixlinks"),willMakeChange(e.$iframe,"Fixing links"),n.fixLinks(a,e,null,e.url,function(){e.refresh(),didMakeChange(e.$iframe)})}});var c=n.getSelectedElementName()||"selected element",f=n.getMimeType(t.name);return f&&f.startsWith("image/")&&(l.push({divider:!0,header:"Images"}),l.push({label:"Insert image after <b>"+c+"</b>",func:function(){r(function(e,r,a){var o=e.makeRelativeUrl(t.url),i='<img src="'+o+'" />',s=(new pgQuery).create(i);n.makeChanges(e,r.parent(),"Insert image",function(){s.insertAfter(a),n.setNeedsUpdate(r.parent())}),n.showQuickMessage("Image inserted.")})}}),l.push({label:"Append image to <b>"+c+"</b>",func:function(){r(function(e,r,a){var o=e.makeRelativeUrl(t.url),i='<img src="'+o+'" />',s=(new pgQuery).create(i);n.makeChanges(e,r,"Append image",function(){a.append(s),n.setNeedsUpdate(r)}),n.showQuickMessage("Image appended.")})}})),l.push({divider:!0,header:"Links"}),l.push({label:"Set href/src of <b>"+c+"</b>",func:function(){r(function(e,r,a){var o,i=e.makeRelativeUrl(t.url),s="img,script,iframe";o=a.is(s)?"src":"href",n.makeChanges(e,r,"Set "+o,function(){a.attr(o,i)}),n.showQuickMessage("<b>"+o+"</b> set to "+i)})}}),l.push({label:"Append link to <b>"+c+"</b>",func:function(){r(function(e,r,a){var o=e.makeRelativeUrl(t.url),i='<a href="'+o+'">'+t.name+"</a>",s=(new pgQuery).create(i);n.makeChanges(e,r,"Insert link",function(){a.append(s)}),n.showQuickMessage("Link appended.")})}}),l.push({label:"Insert link after <b>"+c+"</b>",func:function(){r(function(e,r,a){var o=e.makeRelativeUrl(t.url),i='<a href="'+o+'">'+t.name+"</a>",s=(new pgQuery).create(i);n.makeChanges(e,r.parent(),"Insert link",function(){s.insertAfter(a)}),n.showQuickMessage("Link inserted.")})}}),l},t.aaaon_project_loaded=function(e,t){var r=0;t.forEachEditableFile(function(e,n,t){var a=e.sourceNode.find("[href]");r+=a.length,t.errors.push("Oh no!"),n(e,t)},function(){n.showQuickMessage("Found "+r+" links.")},"Just fooling around...")}})});